# This file is generated by Nx.
#
# Build the docker image with `npx nx docker-build backend`.
# Tip: Modify "docker-build" options in project.json to change docker build args.
#
# Run the container with `docker run -p 3000:3000 --name=backend --network=blogs-network -t backend`.
FROM node:21-bullseye

# Set environment variables
ENV HOST=0.0.0.0
ENV NODE_ENV=production
ENV PORT=3000

# Set the working directory
WORKDIR /app

# Create a system group and user
RUN addgroup --system backend && \
    adduser --system --ingroup backend backend

# Copy the built application code
COPY dist/apps/backend backend
COPY prisma prisma
COPY .env.prod .env

# Change ownership of the copied files
RUN chown -R backend:backend .

# Install production dependencies
RUN yarn --cwd backend install --prod
# RUN yarn setup:api
RUN yarn add prisma
RUN yarn prisma generate --schema prisma/primary/schema.prisma

# Start the application
CMD ["node", "backend"]